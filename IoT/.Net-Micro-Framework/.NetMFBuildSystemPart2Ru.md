

![enter image description here](https://habrastorage.org/files/147/cbe/48e/147cbe48e14c443da2c62920f9c4fe4e.png)

Продолжаем цикл статей, посвященный системе сборки [.Net Micro Framework](https://github.com/NETMF/netmf-interpreter). Понятие "Система сборки проектов" всегда появляется в проектах, масштаб и сложность которых перерастает стандартные типы имеющиеся в составе [IDE](https://ru.wikipedia.org/wiki/%D0%98%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D0%B0%D1%8F_%D1%81%D1%80%D0%B5%D0%B4%D0%B0_%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B8). А если подразумевается что проект будет создаваться в нескольких средах или вообще не привязан к какой бы то ни было среде разработки, то без системы сборки проекта обойтись будет просто невозможно. Ярким примером таких проектов является .Net Micro Framework - реализация платформы Microsoft .NET для микроконтроллеров. 

В [прошлой статье](https://geektimes.ru/post/274094/) был сделан обзор его системы сборки и особенностей ее реализации. Прежде чем двигаться дальше и изучать составные части дистрибутива, нужно познакомиться с инструментами, позволяющими это сделать. В этой статье будет сделан обзор программы PKStudio, которая позволяет удобно исследовать компоненты и связи внутри дистрибутива .Net Micro Framework, а так же обладает другими интересными возможностями.

----------

[PKStuio](https://github.com/AlexandrSurkov/PKStudio) - это результат исследований .NetMF длинной боле года. Программа была написана [мной](https://github.com/AlexandrSurkov) и моим коллегой [Игорем Киселевым](https://github.com/igvas) в процессе изучения внутреннего устройства дистрибутива. Целью было научиться создавать "порты" .NetMF для разных плат. Документация для этого [была](https://netmf.codeplex.com/releases/view/56879), но она не очень то и помогала.

Сначала PKStudio была просто визуализацией MSBuild компонентов и их связей. Но со временем она развивалась и превратилась в [IDE](https://github.com/AlexandrSurkov/PKStudio/wiki/What-is-PKStudio), которая позволяет компилировать "порты", исследовать содержимое дистрибутива, преобразовываться "порты" в проекты для uVisuon Keil и многое другое. Программа была написана в далеком [2011 году](https://blogs.msdn.microsoft.com/netmfteam/2011/06/20/netmf-4-2-porting-kit-studio/) для версии .NetMF 4.2 но и сейчас не потеряла своей [актуальности для версии 4.4](https://github.com/AlexandrSurkov/PKStudio/wiki/How-to-build-PKStudio-with-.Net-Micro-Framework-interpreter-4.4)


Что же такое PKStudio
----------------------

Любой, кто пытался выяснить, что находится внутри .Net Micro Framework знает, что это не для слабонервных. Интересная и перспективная технология имеет множество сложных внутренних взаимосвязей. В процессе анализа репозитория родилась IDE, способная существенно упростить процесс изучения. Она умеет наглядно отображать компоненты и позволяет собирать "порты" из совокупности этих компонент.

В общем виде отображение компонент выглядит так:
![enter image description here](https://camo.githubusercontent.com/9afccbb4577f5d80993650d97abb2bf6d06a20b0/68747470733a2f2f686162726173746f726167652e6f72672f66696c65732f3562342f3162382f6461302f35623431623864613066636234376437616163626338333266663262313431362e706e67)

Изучая составные части репозитория можно двигаться от абстрактных понятий, таких как Features и Library Categories к библиотекам (Library) и исходным файлам:
![enter image description here](https://camo.githubusercontent.com/1c3077d503e71085d9f5daf7b14c93554cc548c2/68747470733a2f2f686162726173746f726167652e6f72672f66696c65732f3838622f3232322f6233342f38386232323262333439613734656661396237323436303333623638633538642e706e67)

Есть возможность построить "порт" и найти ошибки в коде, в случае их наличия:
![enter image description here](https://camo.githubusercontent.com/a418eb29f7f4d3a7a85977c4cb959ce118377aa2/68747470733a2f2f686162726173746f726167652e6f72672f66696c65732f6136312f6666612f6266362f61363166666162663664313434643861396630393334633364323765356230312e706e67)

Одной из самых важный функций является построение графов зависимостей компонент:
![enter image description here](https://camo.githubusercontent.com/79fe28add8212c93d3a9a5c9c9b8829b8248ad91/68747470733a2f2f686162726173746f726167652e6f72672f66696c65732f3965652f3937382f3865652f39656539373838656537306234396161626336623466623564646363356266312e706e67)

Она позволяет увидеть каким образом собирается воедино разрозненный код.

Ну и еще одной важной функцией является конвертер в проекты Keil uVision. Он позволяет создать файл проекта для этой IDE, который будет содержать все необходимые исходники:
![enter image description here](https://camo.githubusercontent.com/b2d0b110c5f4d90b99baa9e50e5015b2487b1b8c/68747470733a2f2f686162726173746f726167652e6f72672f66696c65732f3764302f3265632f3630352f37643032656336303538616134633830613838373239653334313330656435612e706e67)

![enter image description here](https://camo.githubusercontent.com/148c6ffe2eeda8406575ca4e1c6feaec5aaaaf33/68747470733a2f2f686162726173746f726167652e6f72672f66696c65732f3165342f3832612f6238382f31653438326162383862613734663538623561373236653661306432643565372e706e67)

Скриншоты всех функций PKStudio можно посмотреть [тут](https://github.com/AlexandrSurkov/PKStudio/wiki/Screenshots).

Как собрать и запустить PKStudio
--------------------------------

PKStudio имеет множество ссылок на .Net Micro Framework Interpreter. По этому, перед тем как ей воспользоваться, нужно выполнить несколько шагов.

Внимательно прочитайте все пункты перед тем как их выполнять.

 1. Установите Visual Studio 2015 (Community, Pro or Ultimate edition)
 2. Скачайте [исходный код](https://github.com/AlexandrSurkov/PKStudio) PKStudio любым удобным вам способом
 3. Скачайте репозиторий .Net Micro Framework Interpreter. Например [этим](https://github.com/NETMF/netmf-interpreter/wiki/Getting%20Started) способом. Кроме того, разные способы получения репозитория .NetMF описаны в [этой](https://geektimes.ru/post/266612/) и [этой](https://geektimes.ru/post/265986/) статьях.
 4. ВАЖНО: директория с репозиторием Netmf-interpreter и директория с репозиторием PKStudioдолжны иметь общую родительскую директорию! Например, если у вас есть папка *D:\repos*, то репозиторий netmf-interpreter будет находиться в *D:\repos\netmf-interpreter* а PKStudio будет находиться в *D:\repos\PKStudio folder*
 5. Скачайте [binary tools](http://netmf.github.io/downloads/build-tools.zip) zip-файл. Он содержит исполняемые файлы, необходимые для сборки Netmf-interpreter.
 6. Разархивируйте содержимое в  родительскую попку репозитория. Для примера выше директории *bin* and *tools* будут расположены в папке *D:\repos\ * (*D:\repos\bin* и *D:\repos\tools*)

Далее вам нужно собрать часть репозитория .Net Micro Framework Interpreter чтобы получить несколько необходимых DLL файлов.

 1. Откройте командную строку и перейдите в директорию, содержащую .Net Micro Framework Interpreter (например вот так *cd /d D:\WORKDIR\GitHub\netmf-interpreter*)
 2. Установите необходимые переменные окружения, запустив файл *setenv_vs.cmd*
 3. Передите в директорию *.Net Micro Framework Interpreter Framework\Tools* (например вот так *cd /d D:\WORKDIR\GitHub\netmf-interpreter\Framework\Tools*)
 4. Запустите процесс сборки, выполнив команду *msbuild BuildTasks.sln /p:flavor=debug*

Если все было сделано правильно, то сборка будет успешно завершена и вы сможете найти файл *Microsoft.SPOT.Tasks.Internal.dll* в папке *BuildOutput\public\Debug\Server\dll*.

Теперь можно открыть проект PKStudio. Но сделать это нужно с теми же переменными окружения, которые устанавливаются для .Net Micro Framework Interpreter.
Для этого, в той же командной строке, где были установлены переменные окружения, нужно запустить Visual Studio 2015, выполнив *devenv.exe* (например так "C:\Program Files (x86)\Microsoft Visual Studio 14.0\Common7\IDE\devenv.exe" вместе с кавычками)

Когда Visua Studio 2015 будет запущена, вы сможете открыть, собрать и запустить PKStudio.

Для дальнейшей работы уже не обязательно повторять все шаги. Важно понимать только, что для компиляции или запуска PKStudio нужно установить переменные окружения. По этому, если вы захотите что-то поменять в исходной коде, то нужно будет запустить из командной строки с установленными переменными окружения (как указано выше) Visual Studio. А если нужно просто запустить PKStudio, то из командной строки можно сразу запускать *pkstudio.exe*.


Что можно посмотреть с помощью PKStudio
---------------------------------------

Итак, репозитоий .NetMF состоит из нескольких типов компонент. В первую очередь это **Features** - компоненты объединяющие основные функции "порта". **Features** "зависят" от **Library Caterories** - наборов библиотек, реализующих те или иные части **Feature**. **Library Category** могут быть реализованы одной или несколькими **Library** - библиотеками, содержащими сам исходный код. Причем по идее **Library** выполняют один и тот же функционал, но для разных случаев. Например, для разных процессоров. Вроде все просто и логично, но по каким-то причинам, такие связи не всегда соблюдаться для всех компонентов.

PKStudio позволяет генерировать диаграммы, позволяющие понять нюансы отношений между компонентами.

На диаграмме ниже видно раскрытие связей для **Featue** *Debugger*:

![enter image description here](https://camo.githubusercontent.com/d2448bed290470bc1251df59f27bc7041263c782/68747470733a2f2f686162726173746f726167652e6f72672f66696c65732f3835622f3861382f6363652f38356238613863636539316334616339616237613935383338376462366337372e706e67)

Тут все хорошо, кроме того, что две **Library Category** не имеют реализаций в виде **Library**.

А вот диаграмма связей для **Features** *Hardware* и *Core*

![enter image description here](https://camo.githubusercontent.com/79fe28add8212c93d3a9a5c9c9b8829b8248ad91/68747470733a2f2f686162726173746f726167652e6f72672f66696c65732f3965652f3937382f3865652f39656539373838656537306234396161626336623466623564646363356266312e706e67) 

Видно, что *Core* реализуется напрямую несколькими **Libraries** без **Library Category**.

Кроме генерации диаграмм, PKStudio умеет отображать компоненты репозитория в виде древовидной структуры и отображать их свойства.

**Features**:
![enter image description here](https://camo.githubusercontent.com/fec0a5591377f2cc30009ee32c32f3a0f7362c5b/68747470733a2f2f686162726173746f726167652e6f72672f66696c65732f3435382f6238622f3533332f34353862386235333332376134616561626332316165346339333135396563632e706e67)

**Library Categories**:
![enter image description here](https://camo.githubusercontent.com/074a3537f7146aed40581d595f125b84c58930d1/68747470733a2f2f686162726173746f726167652e6f72672f66696c65732f6339322f3066642f3561332f63393230666435613335356234313334616530643166616537646430646361382e706e67)

**Libraries**:
![enter image description here](https://camo.githubusercontent.com/d952f2e3d342c0c30e83f324f15c142ec4f40336/68747470733a2f2f686162726173746f726167652e6f72672f66696c65732f3931302f3333372f3433622f39313033333734336234313634336534626665623839653462643932383632642e706e67)

Кроме того, репозиторий содержит и другие типы компонент.

**Assemblies**:
![enter image description here](https://camo.githubusercontent.com/f3b55e68c7496eb4f87ac1665b3585ef1b5eb9a0/68747470733a2f2f686162726173746f726167652e6f72672f66696c65732f3236322f6430342f3164612f32363264303431646166383734616539396339386433366433313532653965632e706e67)

**Processors**:
![enter image description here](https://camo.githubusercontent.com/b640f7c78b0961c73c57afa4f92b482c90ac4dfb/68747470733a2f2f686162726173746f726167652e6f72672f66696c65732f3038662f3934642f3166322f30386639346431663265653034313664626665646362653537643535663737642e706e67)

Ну и конечно "порты" которые называются **Solutions**. Они представляют собой объединение вышеуказанных компонент:

![enter image description here](https://camo.githubusercontent.com/cc451da836fa3f7580b1d8d87f19021c93590ed0/68747470733a2f2f686162726173746f726167652e6f72672f66696c65732f6438612f3165652f6231332f64386131656562313330626634333865383333623062363737613563366235302e706e67)

Заключение
----------
Кроме того, что описано выше PKStudio, еще имеет поиск по компонентам, верификацию связей между компонентами, конвертер проектов в Keil uVision, возможность компиляции **Solution** и т.д. Но о них будет рассказано в других статьях.

PKStudio - отличный инструмент для знакомства с репозиторием .NetMF. Но он далек от совершенства. По этому, если вы столкнулись с какими-либо проблемами при работе с ним, то пишите коментарии и создавайте [issues](https://github.com/AlexandrSurkov/PKStudio/issues) на GitHub. 

Будем разбираться с [.NetMF](https://github.com/NETMF/netmf-interpreter) и [PKStudio](https://github.com/AlexandrSurkov/PKStudio) вместе!

